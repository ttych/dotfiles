#!/bin/sh
# -*- mode: sh -*-


set -e


TCD_CUSTOM_CONF_DIR="${TCD_CUSTOM_CONF_DIR:-$HOME/.tmux/custom_conf}"
TCD_LOCAL_CONF_NAME=".tmux.local.conf"


echo2()
{
    echo >&2 "$@"
}


########### tmux

_has_tmux()
{
    _has_tmux=$(which tmux 2>/dev/null)
}

_in_tmux()
{
    [ -n "$TMUX" ]
}

_tmux_has_session()
{
    [ -z "$1" ] && return 1
    tmux has-session -t "$1" 2>/dev/null
}

_tmux_list_session()
{
    _tmux_list_session__format="$1"
    tmux list-session ${_tmux_list_session__format:+-F "$_tmux_list_session__format"}
}


########### tcd

tcd_list_session()
{
    _tmux_list_session "#{session_name} #{session_path}" | column -t
}

tcd_cd()
{
    tcd__target_dir="$1"
    if [ ! -d "$tcd__target_dir" ]; then
        echo2 "Error: Directory '$tcd__target_dir' does not exist."
        return 1
    fi

    tcd__target_abs_dir=$(cd "$tcd__target_dir" && pwd)
    tcd__session_name=$(basename "$tcd__target_abs_dir" | tr ':.' '_')

    if _tmux_has_session "$tcd__session_name" 2>/dev/null; then
        if [ "tcd__detach" -eq 1 ]; then
            return 0
        fi
    else
        tmux new-session -d -s "$tcd__session_name" -c "$tcd__target_abs_dir"

        if [ -n "$tcd__custom_conf" ]; then
            tcd__custom_conf_path="$TCD_CUSTOM_CONF_DIR/$tcd__custom_conf"
            if [ -f "$tcd__custom_conf_path" ]; then
                tmux source-file -t "$tcd__session_name" "$tcd__custom_conf_path"
            else
                echo2 "Warning: Custom config '$tcd__custom_conf_path' not found."
            fi
        else
            if [ -f "$tcd__target_abs_dir/$TCD_LOCAL_CONF_NAME" ]; then
                tmux source-file -t "$tcd__session_name" "$tcd__target_abs_dir/$TCD_LOCAL_CONF_NAME"
            fi
        fi
    fi

    tcd_attach "tcd__session_name"
}

tcd_attach()
{
   if [ "$tcd__detach" -eq 1 ]; then
        echo2 "Session '$1' created/running in background."
        return 0
    fi

    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$1"
    else
        tmux attach-session -t "$1"
    fi
}

tcd_usage() {
    echo2 "Usage: tcd [-d] [-c config_name] <directory|session>"
    echo2 "  -c config_name  Load config from $TCD_CUSTOM_CONF_DIR/<config_name>"
    echo2 "  -d              Run detached (do not attach)"
    echo2 "  -l              List sessions"

    if [ -n "$1" ]; then
        exit "$1"
    fi
}

tcd()
{
    if ! _has_tmux; then
        echo2 "tmux not found in PATH"
        return 1
    fi

    tcd__detach=0
    tcd__custom_conf=""
    tcd__action=

    OPTIND=1
    while getopts :hxbc:dl opt; do
        case $opt in
            h) tcd_usage 0; exit 0 ;;
            x) set -x ;;
            b|d) tcd__detach=1 ;;
            c) tcd__custom_conf="$OPTARG" ;;
            l) tcd__action=list_session ;;
            \?) tcd_usage 1 ;;
        esac
    done
    shift $(($OPTIND - 1))

    if [ -z "$tcd__action" ]; then
        if [ -n "$1" ]; then
            if [ -d "$1" ]; then
                tcd__action="cd"
            elif _tmux_has_session "$1"; then
                tcd__action="attach"
            else
                echo2 "Error: \"$1\" is not a Directory and not a session"
                return 1
            fi
        else
            tcd__action="list_session"
        fi
    fi

    "tcd_${tcd__action}" "$@"
}


########### main

tcd "$@"
