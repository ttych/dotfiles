#!/bin/sh
# -*- mode: sh -*-

set -e

# LOAD_AVG_STATUS_LOGO='ðŸƒ'
# LOAD_AVG_STATUS_LOGO='âŒ—'
# LOAD_AVG_STATUS_LOGO='ðŸ§ '
LOAD_AVG_STATUS_LOGO='ðŸ”§'

LOAD_AVG_STATUS_COLOR_OK='green'
LOAD_AVG_STATUS_COLOR_OK_SH='\\033[38;2;0;255;0m'
LOAD_AVG_STATUS_COLOR_WARN='yellow'
LOAD_AVG_STATUS_COLOR_WARN_SH='\\033[38;2;255;255;0m'
LOAD_AVG_STATUS_COLOR_ALERT='red'
LOAD_AVG_STATUS_COLOR_ALERT_SH='\\033[38;2;255;0;0m'
LOAD_AVG_STATUS_COLOR_RESET='\033[0m'

LOAD_AVG_STATUS_FORMAT="{color_sh}{logo_c}{load_ratio}${LOAD_AVG_STATUS_COLOR_RESET}\n"
LOAD_AVG_STATUS_TMUX_FORMAT=' #[fg={color}]{logo_c}{load_ratio}#[fg=default] '


load_avg_status_Linux()
{
    load_avg_status_load=`cat /proc/loadavg`
    load_avg_status_load="${load_avg_status_load%% *}"
    load_avg_status_core=`grep -c '^processor' /proc/cpuinfo`
    load_avg_status_load_ratio="${load_avg_status_load:-?}/${load_avg_status_core:-?}"
}

load_avg_status_set_color()
{
    if which ruby >/dev/null 2>/dev/null; then
        load_average_percentage=$(ruby --disable-all -e "puts ($load_avg_status_load*100.0/$load_avg_status_core).round")
    elif which python >/dev/null 2>/dev/null; then
        load_average_percentage=$(python -c "print(round($load_avg_status_load*100.0/$load_avg_status_core))")
    fi

    if [ $load_average_percentage -le 40 ]; then
        load_avg_status_color="$LOAD_AVG_STATUS_COLOR_OK"
        load_avg_status_color_sh="$LOAD_AVG_STATUS_COLOR_OK_SH"
    elif [ $load_average_percentage -le 70 ]; then
        load_avg_status_color="$LOAD_AVG_STATUS_COLOR_WARN"
        load_avg_status_color_sh="$LOAD_AVG_STATUS_COLOR_WARN_SH"
    else
        load_avg_status_color="$LOAD_AVG_STATUS_COLOR_ALERT"
        load_avg_status_color_sh="$LOAD_AVG_STATUS_COLOR_ALERT_SH"
    fi
}

load_avg_status_display()
{
    load_avg_status_display__format="$1"

    load_avg_status_display__format=$(echo "$load_avg_status_display__format" | sed "s/{color}/${load_avg_status_color}/g")
    load_avg_status_display__format=$(echo "$load_avg_status_display__format" | sed "s/{color_sh}/${load_avg_status_color_sh}/g")
    load_avg_status_display__format=$(echo "$load_avg_status_display__format" | sed "s/{logo_c}/${load_avg_status_logo_c}/g")
    load_avg_status_display__format=$(echo "$load_avg_status_display__format" | sed "s/{load}/${load_avg_status_load}/g")
    load_avg_status_display__format=$(echo "$load_avg_status_display__format" | sed "s/{core}/${load_avg_status_core}/g")
    load_avg_status_display__format=$(echo "$load_avg_status_display__format" | sed "s,{load_ratio},${load_avg_status_load_ratio},g")

    printf "%s" "$load_avg_status_display__format"
}

load_avg_status()
{
    load_avg_status__usage="load_avg_status [options]

with options:
  -h            help
  -x            debug
  -f FORMAT     output format
  -t            tmux output format
"
    load_avg_status__format="$LOAD_AVG_STATUS_FORMAT"
    load_avg_status__os=`uname`

    OPTIND=1
    while getopts :hxf:t opt; do
        case $opt in
            h) printf "$load_avg_status_status__usage" ; exit 0 ;;
            x) set -x ;;
            f) load_avg_status__format="$OPTARG" ;;
            t) load_avg_status__format="$LOAD_AVG_STATUS_TMUX_FORMAT" ;;
        esac
    done
    shift $(($OPTIND - 1))

    load_avg_status_logo_c="$LOAD_AVG_STATUS_LOGO"
    load_avg_status_color="$LOAD_AVG_STATUS_COLOR"
    load_avg_status_color_sh="$LOAD_AVG_STATUS_COLOR_SH"
    load_avg_status_seconds='???'
    load_avg_status_human='???sec'

    load_avg_status_${load_avg_status__os}
    load_avg_status_set_color
    load_avg_status_display "$load_avg_status__format"
}


########### main
load_avg_status "$@"
