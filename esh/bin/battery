#!/bin/sh
# -*- mode: sh -*-

set -e

# BATTERY_LOGO='âš¡'
# BATTERY_LOGO='ðŸ”‹'
BATTERY_LOGO='ðŸ”Œ'
BATTERY_C_FULL='='
BATTERY_C_CHARGE='+'
BATTERY_C_DISCHARGE='-'

BATTERY_COLOR_OK='green'
BATTERY_COLOR_OK_SH='\\033[38;2;0;255;0m'
BATTERY_COLOR_WARN='yellow'
BATTERY_COLOR_WARN_SH='\\033[38;2;255;255;0m'
BATTERY_COLOR_ALERT='red'
BATTERY_COLOR_ALERT_SH='\\033[38;2;255;0;0m'
BATTERY_COLOR_RESET='\033[0m'

BATTERY_FORMAT="{color_sh}{logo_c}{state_c}{percent}${BATTERY_COLOR_RESET}\n"
BATTERY_TMUX_FORMAT=' #[fg={color}]{logo_c}{state_c}{percent}#[fg=default] '


########### Linux

upower_cmd()
{
    upower_cmd__battery="$1"

    if [ -z "$upower_cmd__battery" ]; then
        upower_cmd__battery=$(upower -e | grep -i bat | head -1)
    fi
    if [ -z "upower_cmd__battery" ]; then
        return 0
    fi

    upower -i "$upower_cmd__battery"
}

upower_status()
{
    upower_status=$(upower_cmd | awk '
        $1 ~ /state:/ { print "upower_state=\""$2"\"" }
        $1 ~ /percentage:/ { print "upower_percentage=\""$2"\"" }
    ')
    eval "$upower_status"
}

battery_Linux_status()
{

    battery_state=
    battery_percentage=
    battery_percentage_i=

    upower_status || return 1

    battery_state="$upower_state"
    battery_percentage="$upower_percentage"
    battery_percentage_i="${battery_percentage%%%}"
}

########### FreeBSD
battery_FreeBSD_status()
{
    battery_FreeBSD_status=`sysctl -n hw.acpi.battery.state`
    case "$battery_FreeBSD_status" in
        1) battery_state=discharging ;;
        2) battery_state=charging ;;
        *) battery_state='?' ;;
    esac
    battery_percentage=`sysctl -n hw.acpi.battery.life`
    battery_percentage_i="${battery_percentage%%%}"
}

########### color
battery_set_ok_color()
{
    battery_color="$BATTERY_COLOR_OK"
    battery_color_sh="$BATTERY_COLOR_OK_SH"
}

battery_set_warn_color()
{
    battery_color="$BATTERY_COLOR_WARN"
    battery_color_sh="$BATTERY_COLOR_WARN_SH"
}

battery_set_alert_color()
{
    battery_color="$BATTERY_COLOR_ALERT"
    battery_color_sh="$BATTERY_COLOR_ALERT_SH"
}

battery_display_status()
{
    battery_display_status__format="$1"

    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{color}/${battery_color}/g")
    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{color_sh}/${battery_color_sh}/g")
    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{logo_c}/${battery_logo_c}/g")
    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{percent_i}/${battery_percentage_i}/g")
    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{percent}/${battery_percentage}/g")
    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{state}/${battery_state}/g")
    battery_display_status__format=$(echo "$battery_display_status__format" | sed "s/{state_c}/${battery_state_c}/g")

    printf "%s" "$battery_display_status__format"
}

battery()
{
    battery__usage="battery [options]

with options:
  -h            help
  -x            debug
  -f FORMAT     format output
"
    battery__format="$BATTERY_FORMAT"
    battery__os=`uname`

    OPTIND=1
    while getopts :hxf:t opt; do
        case $opt in
            h) printf "$battery_status__usage" ; exit 0 ;;
            x) set -x ;;
            f) battery__format="$OPTARG" ;;
            t) battery__format="$BATTERY_TMUX_FORMAT" ;;
        esac
    done
    shift $(($OPTIND - 1))

    battery_set_ok_color
    battery_logo_c="$BATTERY_LOGO"
    battery_percent='???'
    battery_state='?'
    battery_state_c='?'

    battery_${battery__os}_status

    case "$battery_state" in
        fully-charged)
            battery_state_c="$BATTERY_C_FULL" ;;
        discharging)
            battery_state_c="$BATTERY_C_DISCHARGE" ;;
        charging)
            battery_state_c="$BATTERY_C_CHARGE" ;;
    esac
    case "$battery_percentage_i" in
        0*|1?|2*)
            battery_color="$BATTERY_COLOR_ALERT" ;;
        3*|4*|5*)
            battery_color="$BATTERY_COLOR_WARN" ;;
    esac

    battery_display_status "$battery__format"
}


########### main
battery "$@"
