#!/bin/sh
# -*- mode: sh -*-


# set -e
# set -x


if [ -z "$TMUX_CONF_DIR" ]; then
    for d in "$HOME" "$HOME_ALT"; do
        [ -z "$d" ] && continue
        [ -d "$d/.tmux/" ] && TMUX_CONF_DIR="$d/.tmux" && break
    done
fi
TMUX_CONF_DIR="${TMUX_CONF_DIR:-$HOME/.tmux}"
TMUX_CUSTOM_CONF_DIR="${TMUX_CONF_DIR}/custom"

ATX_LOCAL_CONF_NAME=".tmux.local.conf"


is_sourced() {
    if [ -n "$ZSH_VERSION" ]; then
        case $ZSH_EVAL_CONTEXT in *:file:*) return 0;; esac
    else  # Add additional POSIX-compatible shell names here, if needed.
        case ${0##*/} in dash|-dash|bash|-bash|ksh|-ksh|sh|-sh) return 0;; esac
    fi
    return 1  # NOT sourced.
}



########### base

echo2()
{
    echo >&2 "$@"
}



########### tmux

_has_tmux()
{
    _has_tmux=$(which tmux 2>/dev/null)
}

_in_tmux()
{
    [ -n "$TMUX" ]
}

_tmux_has_session()
{
    [ -z "$1" ] && return 1
    tmux has-session -t "$1" 2>/dev/null
}


_tmux_current_session()
{
    _in_tmux || return 1

    # _tmux_current_session=$(tmux display-message -p '#S')

    tty=$(tty)
    _tmux_current_session=$(
        for s in $(tmux list-sessions -F '#{session_name}'); do
            tmux list-panes -F '#{pane_tty} #{session_name}' -t "$s"
        done | grep "^$tty " | awk '{print $2}'
                        )

    echo $_tmux_current_session
}

_tmux_list_session()
{
    _tmux_list_session__format="$1"
    tmux list-session ${_tmux_list_session__format:+-F "$_tmux_list_session__format"}
}



########### atx

_atx_load_custom_conf()
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        return 1
    fi
    [ -f "$TMUX_CUSTOM_CONF_DIR/$2" ] || return 1

    tmux source-file -t "$1" "$TMUX_CUSTOM_CONF_DIR/$2"
}

_atx_load_local_conf()
{
    if [ -z "$1" ] || [ -z "$2" ]; then
        return 1
    fi
    [ -f "$2/$ATX_LOCAL_CONF_NAME" ] || return 1

    tmux source-file -t "$1" "$2/$ATX_LOCAL_CONF_NAME"
}

_atx_normalize_session_name()
{
    _atx_normalize_session_name="$(echo $1 | tr :. _)"
}

_atx_resolve_path()
{
    _atx_resolve_path=$(cd "$1" && pwd)
}

_atx_session_name_from_path()
{
    if [ "$1" = "$HOME" ]; then
        _atx_session_name_from_path="home"
    else
        _atx_session_name_from_path="${1##*/}"
    fi
}

_atx_list_session()
{
    _tmux_list_session "#{session_name} #{session_path}" | column -t
}

_atx_session()
{
    _tmux_has_session "=$1" && return 0

    _atx_session__name="$1"
    _atx_session__path="${2:-$PWD}"

    _atx_normalize_session_name "$_atx_session__name"
    _atx_session__name="$_atx_normalize_session_name"
    _atx_resolve_path "$_atx_session__path"
    _atx_session__path="$_atx_resolve_path"

    TMUX= tmux new-session -d -s "$_atx_session__name" -c "$_atx_session__path" || return 1

    _atx_load_custom_conf "$_atx_session__name" "$atx__custom_conf" ||
        _atx_load_custom_conf "$_atx_session__name" "session.$_atx_session__name"

    _atx_load_local_conf "$_atx_session__name" "$_atx_session__path"

    return 0
}

_atx_attach()
{
   if [ "$atx__detach" -eq 1 ]; then
        echo2 "Session '$1' created/running in background."
        return 0
    fi

    if _in_tmux; then
        tmux switch-client -t "$1"
    else
        tmux attach-session -t "$1"
    fi
}

_atx_session_and_switch()
{
    if _tmux_has_session "=$1"; then
        [ "atx__detach" -eq 1 ] && return 0
    else
        _atx_session "$@" || return 1
    fi

    _atx_attach "$1"
}

_atx_usage()
{
    cat <<EOF
usage is
    atx <options> <parameters>

options in:
    -h               : help
    -c config_name   : load config from $TMUX_CUSTOM_CONF_DIR
    -d               : do action in detached mode
    -l               : list session

examples:
    atx  --  use current dir as starting point
    atx  <params>  --  in order existing-session,path,new-session
    atx  <name> <path>  --  in order existing-session,new-session-within-path
EOF

    if [ -n "$1" ]; then
        exit "$1"
    fi
}

atx()
{
    if ! _has_tmux; then
        echo2 "tmux not found in PATH"
        return 1
    fi

    atx__detach=0
    atx__custom_conf=
    atx__action=
    atx__session=
    atx__path=

    OPTIND=1
    while getopts :hxbc:dl opt; do
        case $opt in
            h) _atx_usage 0 ;;
            x) set -x ;;
            b|d) atx__detach=1 ;;
            c) atx__custom_conf="$OPTARG" ;;
            l) atx__action=list_session ;;
            \?) echo2 "unexpected parameter \"$opt\""
                echo2 ""
                atx_usage 1 ;;
        esac
    done
    shift $(($OPTIND - 1))

    if [ -n "$atx__action" ]; then
        "_atx_${atx__action}" "$@"
        return $?
    fi

    if [ "$1" = "_init_" ]; then
        _in_tmux && return 0
        shift
    fi

    case $# in
        0) atx__path="$PWD"
           ;;
        1) atx__path="$PWD"
           if _tmux_has_session "=$1"; then
               atx__session="$1"
            elif [ -d "$1" ]; then
                atx__path="$1"
            else
                atx__session="$1"
            fi
            ;;
        2)
            if [ -d "$2" ]; then
                atx__path="$2"
                atx__session="$1"
            else
                echo2 "2nd argument should be a path"
                echo2 ""
                atx_usage 1
            fi
            ;;
        *) echo2 "too many arguments: $#"
           echo2 ""
           atx_usage 1
           ;;
    esac

    _atx_resolve_path "${atx__path:-$PWD}"
    atx__path="$_atx_resolve_path"

    if [ -z "$atx__session" ]; then
        _atx_session_name_from_path "$atx__path"
        atx__session="$_atx_session_name_from_path"
    fi
    _atx_normalize_session_name "$atx__session"
    atx__session="$_atx_normalize_session_name"

    _atx_session_and_switch "$atx__session" "$atx__path"
}



########### main

if ! is_sourced; then
    #  && [ "${0##*/}" = 'atx' ]
    atx "$@"
fi
